# 二脚ロボット制御ソフトウェア 全体アーキテクチャ設計

## 1. システム概要

### 1.1 プロジェクト概要
- **目標**: GIM6010-8モーターを使用した二脚ロボットの歩行制御システム
- **開発フェーズ**: プロトタイプ段階
- **主要技術**: Python、CAN通信、リアルタイム制御

### 1.2 ハードウェア構成
- **モーター構成**: 
  - 左脚: 5関節（股関節ヨー、股関節ロール、股関節ピッチ、膝、足首）
  - 右脚: 5関節（股関節ヨー、股関節ロール、股関節ピッチ、膝、足首）
  - 首: 1関節
  - **合計**: 11個のGIM6010-8モーター
- **通信**: CAN通信によるモーター制御
- **入力デバイス**: Bluetooth接続ゲームパッド
- **制御基板**: Jetson Orin Nano（将来的に導入）

## 2. システムアーキテクチャ

### 2.1 レイヤー構成
```
┌─────────────────────────────────────┐
│        アプリケーション層             │
│  ・歩行制御アルゴリズム               │
│  ・ユーザーインターフェース           │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│           制御層                    │
│  ・関節制御                         │
│  ・軌道生成                         │
│  ・安全監視                         │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│         通信・抽象化層               │
│  ・モーター抽象化                   │
│  ・CAN通信管理                      │
│  ・入力デバイス管理                 │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│          ハードウェア層             │
│  ・CANインターフェース              │
│  ・GIM6010-8モーター                │
│  ・Bluetoothゲームパッド            │
└─────────────────────────────────────┘
```

### 2.2 主要モジュール構成

#### 2.2.1 core/ - コア機能
- **robot_model.py**: ロボットの物理モデル定義
- **joint_manager.py**: 関節管理クラス
- **safety_monitor.py**: 安全監視システム

#### 2.2.2 communication/ - 通信機能
- **can_interface.py**: CAN通信の低レベルインターフェース
- **motor_driver.py**: GIM6010-8モーター専用ドライバー
- **gamepad_interface.py**: Bluetoothゲームパッド通信

#### 2.2.3 control/ - 制御機能
- **joint_controller.py**: 単関節制御器
- **pose_controller.py**: 姿勢制御器
- **gait_generator.py**: 歩容生成器（将来拡張）

#### 2.2.4 utils/ - ユーティリティ
- **logger.py**: ログ管理
- **config_manager.py**: 設定ファイル管理
- **math_utils.py**: 数学計算ユーティリティ

#### 2.2.5 app/ - アプリケーション
- **main.py**: メインアプリケーション
- **manual_control.py**: 手動制御モード
- **walking_control.py**: 歩行制御モード（将来実装）

## 3. データフロー

### 3.1 制御ループ
```
[ゲームパッド入力] → [入力処理] → [目標姿勢生成] → [関節角度計算] 
    ↓
[安全チェック] → [CAN通信] → [モーター制御] → [フィードバック取得]
    ↑                                            ↓
[ログ出力] ← [状態監視] ← [センサーデータ処理] ←────┘
```

### 3.2 主要データ構造
```python
# 関節状態
@dataclass
class JointState:
    position: float      # 現在角度 [rad]
    velocity: float      # 角速度 [rad/s]
    torque: float       # トルク [Nm]
    temperature: float   # 温度 [℃]
    current: float      # 電流 [A]

# ロボット状態
@dataclass
class RobotState:
    joints: Dict[str, JointState]
    timestamp: float
    is_safe: bool
```

## 4. 通信プロトコル

### 4.1 CAN通信仕様
- **通信速度**: 1Mbps
- **フレーム形式**: 拡張フレーム（29bit ID）
- **モーターID割り当て**:
  ```
  左脚: 0x01-0x05 (ヨー、ロール、ピッチ、膝、足首)
  右脚: 0x06-0x0A (ヨー、ロール、ピッチ、膝、足首)
  首:   0x0B
  ```

### 4.2 制御コマンド
- **位置制御**: 目標角度 + 最大速度 + 最大トルク
- **速度制御**: 目標角速度 + 最大トルク
- **トルク制御**: 目標トルク
- **状態取得**: 現在位置、速度、トルク、温度、電流

## 5. 安全機能

### 5.1 監視項目
- **過電流検出**: モーター電流の閾値監視
- **温度監視**: モーター温度の異常検出
- **位置制限**: 各関節の可動範囲チェック
- **通信エラー**: CANフレーム送受信エラー検出

### 5.2 安全動作
- **緊急停止**: 全モーターの即座停止
- **安全姿勢**: 予定義された安全な姿勢への移行
- **アラート出力**: ログとコンソールへの警告出力

## 6. 設定管理

### 6.1 設定ファイル構造
```yaml
# config/robot_config.yaml
robot:
  joints:
    left_hip_yaw: {id: 1, min_angle: -180, max_angle: 180}
    left_hip_roll: {id: 2, min_angle: -45, max_angle: 45}
    # ... 他の関節定義
  
  safety:
    max_current: 10.0  # A
    max_temperature: 80.0  # ℃
    emergency_stop_timeout: 1.0  # sec

communication:
  can:
    interface: "can0"
    bitrate: 1000000
  gamepad:
    device_name: "wireless_controller"
```

## 7. 開発・テスト戦略

### 7.1 開発段階
1. **Phase 1**: 基本通信・単関節制御
2. **Phase 2**: 複数関節協調・安全機能
3. **Phase 3**: 姿勢制御・手動操作
4. **Phase 4**: 歩行アルゴリズム実装

### 7.2 テスト方針
- **単体テスト**: 各モジュールの独立テスト
- **統合テスト**: モジュール間の連携テスト
- **実機テスト**: 段階的な実機検証

## 8. 今後の拡張予定

### 8.1 センサー統合
- IMU統合による姿勢推定
- 足圧センサーによる接地検出
- カメラによる環境認識

### 8.2 高度な制御機能
- 動歩行アルゴリズム
- バランス制御
- 外乱対応制御

### 8.3 ユーザーインターフェース
- WebUI による遠隔監視
- パラメーター調整画面
- リアルタイムデータ可視化

---

**更新履歴**
- 2025/09/26: 初版作成
