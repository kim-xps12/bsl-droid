## 概要

このディレクトリには，USB接続されたGIM6010-8モータについて，設定・検証・管理するためのスクリプトが含まれています．

対象スクリプト（パスはこのREADMEからの相対パス）:

- `src/change_can_id.py` — ODriveのCAN Node IDを変更するスクリプト
- `src/execute_setup_and_calibrate.py` — GIM6010-8向けにODriveの初期設定とキャリブレーションを実行するスクリプト
- `src/verify_setup_and_calibrate.py` — 初期設定後に設定値が期待値どおりに設定されているかを検証するスクリプト


## 前提条件

- SteadyWin GIM6010-8がデバッグ用USBポートでPCと接続されていること

## 動作環境

### システム要件

- Python: 3.10以上
- OS: macOS / Linux（USB接続によるODrive通信）
- パッケージマネージャ: uv

### 環境構築

#### uvを使用した環境構築

このプロジェクトでは[uv](https://github.com/astral-sh/uv)を使用しています．

```bash
# Macへのuvのインストール（未インストールの場合）
brew install uv

# Ubuntuへのuvのインストール（未インストールの場合）
curl -LsSf https://astral.sh/uv/install.sh | sh

# プロジェクトのルートディレクトリ（software/）に移動
cd /path/to/bsl-droid/software

# 依存関係のインストール（pyproject.tomlとuv.lockから自動インストール）
uv sync

# スクリプトの実行例
uv run src/tools_gim6010_usb/src/change_can_id.py
```

## 安全上の注意

- 校正（キャリブレーション）やテスト中はモータが回転します．モータ・出力軸・周辺機器がしっかり固定されていることを確認してください．
- 高電圧・大電流が関係します．必要に応じて安全保護具を着用してください．
- 設定保存や再起動によってODriveとの接続が一時的に切れるため，重要な作業中は注意してください．

## スクリプト別使い方（開発者向け）

以下は各スクリプトの概略と実行例です．スクリプトはすべてインタラクティブな確認プロンプトを含むものがあるため，自動化する場合はその点に注意してください．

### 1) change_can_id.py

目的: USB接続されたODriveのCAN Node IDを変更します．

主な特徴:
- コマンドライン引数で新しいIDを与えることが可能（非対話モード）
- ID範囲は 0〜63
- 設定保存後にODriveが再起動します

実行例:

```bash
# 対話モード（引数なし）
b-sky-lab@Mac software % uv run python src/tools_gim6010_usb/src/change_can_id.py

odriveデバイス接続待ち...
接続成功: 107168064615245
使用方法: python change_can_id.py [新しいID]
例: python change_can_id.py 5

インタラクティブモードで起動します...
==================================================

【現在のCAN ID情報】
  CAN Node ID: 32
  シリアル番号: 107168064615245

新しいCAN ID (0～63): 31
==================================================
ODrive CAN ID変更スクリプト
==================================================

ODriveに接続中...
✓ 接続成功: 107168064615245

【現在のCAN ID情報】
  CAN Node ID: 32
  シリアル番号: 107168064615245

変更後のCAN ID: 31

CAN IDを変更しますか? (y/n): y

CAN IDを変更中...
✓ CAN IDを 32 → 31 に変更しました

設定を保存中...
注意: 保存後，ODriveが再起動します
✓ 設定保存完了（再起動により切断）
ODriveが再起動しています...

変更を確認中...

【現在のCAN ID情報】
  CAN Node ID: 31
  シリアル番号: 107168064615245

✓ CAN ID変更完了: 32 → 31

==================================================
CAN ID変更が完了しました!
==================================================
```

```bash
# 引数で指定して実行（例: 新しいIDを5に設定する）
b-sky-lab@Mac software % uv run python src/tools_gim6010_usb/src/change_can_id.py 5

odriveデバイス接続待ち...
接続成功: 107168064615245
==================================================
ODrive CAN ID変更スクリプト
==================================================

ODriveに接続中...
✓ 接続成功: 107168064615245

【現在のCAN ID情報】
  CAN Node ID: 31
  シリアル番号: 107168064615245

変更後のCAN ID: 5

CAN IDを変更しますか? (y/n): y

CAN IDを変更中...
✓ CAN IDを 31 → 5 に変更しました

設定を保存中...
注意: 保存後，ODriveが再起動します
✓ 設定保存完了（再起動により切断）
ODriveが再起動しています...

変更を確認中...

【現在のCAN ID情報】
  CAN Node ID: 5
  シリアル番号: 107168064615245

✓ CAN ID変更完了: 31 → 5

==================================================
CAN ID変更が完了しました!
==================================================
```

挙動メモ:
- スクリプトは接続されたODriveを `odrive.find_any()` で待ちます．
- 現在値表示 → 確認プロンプト → 変更 → `save_configuration()` → 再接続確認 の流れです．
- 自動実行（無人環境）で使う場合は stdin を工夫するかスクリプトを改変して確認プロンプトをスキップしてください．

### 2) execute_setup_and_calibrate.py

目的: GIM6010-8の初期設定とモータ/エンコーダのキャリブレーションを行います．

主な処理:
- 極対数，CPR，トルク定数，電流制限などハードウェアパラメータを設定
- PID（pos/vel）や各種保護・CAN設定を適用
- モータキャリブレーション（MOTOR_CALIBRATION）を実行
- エンコーダのオフセットキャリブレーションを実行
- 校正済みフラグをセットして設定を保存（保存後再起動）
- オプションで簡単なモータ動作テストを実行

実行例:

```bash
b-sky-lab@Mac software % uv run python src/tools_gim6010_usb/src/execute_setup_and_calibrate.py
==================================================
GIM6010-8 ODrive初期設定スクリプト
==================================================
ODriveに接続中...
✓ 接続成功: 107168064615245

エラーをクリア中...

=== ハードウェアパラメータ設定 ===
極対数: 14
エンコーダCPR: 16384
トルク定数: 0.4700 Nm/A
電流制限: 10.0 A
校正最大電圧: 11 V
校正電流: 7.0 A
速度制限: 30.0 turn/s
トルクモード速度リミットを有効化
電圧範囲: 12.0V - 48.0V
放電電流最大値(負): -10.0 A
放電電流最大値(正): 15.0 A

温度保護設定（モータサーミスタ）
  有効化: True
  下限温度: 20℃
  上限温度: 100℃
  現在温度: 30.855533599853516℃

温度保護設定（FETサーミスタ）
  有効化: True
  下限温度: 20℃
  上限温度: 100℃
  現在温度: 37.945858001708984℃

CANバス設定
  ボーレート: 1000000
  エンコーダカウントレート: 10 ms
  バスVI更新レート: 100 ms

✓ ハードウェアパラメータ設定完了

=== PIDパラメータ設定 ===
位置ゲイン: 20.0
速度ゲイン: 0.16
速度積分ゲイン: 0.32
✓ PIDパラメータ設定完了

=== モータ校正 ===
CPRを設定: 16384
警告: モータが回転します．固定されていることを確認してください．
校正を開始しますか? (y/n): y
モータパラメータ自動識別中...
「ピッ」という音が聞こえます...
モータパラメータ校正待ち...: 100%|███| 10/10 [00:10<00:00,  1.00s/秒]

=== エラーチェック ===
axis error: 0x0000
motor error: 0x0000
encoder error: 0x0000
controller error: 0x0000
✓ エラーなし

測定結果:
  相抵抗: 0.2605 Ω
  相インダクタンス: 0.000125 H
✓ モータ校正完了

=== エンコーダ校正 ===
モータがゆっくり正転・逆転します...
現在のCPR設定: 16384
現在の極対数: 14
エンコーダーキャリブレーション中...
エンコーダーキャリブレーション待機:  76%|▊| 68/90 [01:08<00:22,  1.00✓ キャリブレーション完了（IDLE状態に遷移）
エンコーダーキャリブレーション待機:  76%|▊| 68/90 [01:08<00:22,  1.01

=== エラーチェック ===
axis error: 0x0000
motor error: 0x0000
encoder error: 0x0000
controller error: 0x0000
✓ エラーなし
✓ エンコーダ校正完了

校正済みフラグを設定中...
✓ 校正済みフラグ設定完了

設定を保存中...
注意: 保存後，ODriveが再起動します
✓ 設定保存完了（再起動により切断）
ODriveが再起動しています...
再起動待機: 100%|██████████████████████| 5/5 [00:05<00:00,  1.00s/秒]
✓ 再起動完了（設定は保存されました）

=== モータ動作テスト ===
モータテストを実行しますか? (y/n): y
出力軸での揺動角度: ±90.0度
ODriveに再接続中...
✓ 再接続完了

クローズドループ制御に移行...

=== エラーチェック ===
axis error: 0x0000
motor error: 0x0000
encoder error: 0x0000
controller error: 0x0000
✓ エラーなし
✓ クローズドループ制御に移行しました

現在位置: -2.501 turn (モーター軸)
位置制御テスト: 出力軸で±90度（モーター軸で±720度）の揺動を1回実行...
  刻み幅: 出力軸1度 = モーター軸8度
  出力軸+90.0度へ移動中...
  出力軸-90.0度へ移動中...
  元の位置へ戻り中...
✓ 揺動テスト完了
最終位置: -2.541 turn (誤差: 0.0400 turn = 1.80度[出力軸])

アイドル状態に移行...
✓ モータ動作テスト完了

==================================================
初期設定が完了しました!
==================================================
```

注意事項:
- 実行中は対話プロンプト（校正開始の確認など）があります．
- キャリブレーション前に出力軸が固定されていること，且つ出力軸に負荷がかかっていないことを必ず確認してください．
- スクリプト内で使われている期待値（極対数やCPRなど）はクラス定数として `GIM6010Setup` 内に定義されています．別のモータ/構成で使う場合はここを変更してください．

### 3) verify_setup_and_calibrate.py

目的: `execute_setup_and_calibrate.py` 実行後に，ODriveの設定が期待値どおりに反映されているかを自動で検証します．

主な特徴:
- 各種パラメータを読み出して期待値と比較（許容誤差あり）
- デフォルトで`assert`構文を用いて値の異常が見つかるとエラー終了します．デバッグ時には`--assert False`オプションを用いて無効化できます．

実行例:

```bash
# 通常実行（不一致があれば失敗として終了）
b-sky-lab@Mac software % uv run python src/tools_gim6010_usb/src/verify_setup_and_calibrate.py
============================================================
GIM6010-8 ODrive設定値確認スクリプト
============================================================

ODriveに接続中...
✓ 接続成功: シリアル番号 107168064615245
  ハードウェアバージョン: 3.11
  ファームウェアバージョン: 0.5.16

============================================================
【モータパラメータ】
============================================================
  ✓ 極対数: 14
  ✓ トルク定数: 0.4699999988079071 Nm/A (期待値: 0.47 Nm/A, 誤差: 0.000000 Nm/A)
  ✓ 電流制限: 10.0 A (期待値: 10.0 A, 誤差: 0.000000 A)
  ✓ 校正電流: 7.0 A (期待値: 7.0 A, 誤差: 0.000000 A)
  ✓ 校正最大電圧: 11.0 V (期待値: 11.0 V, 誤差: 0.000000 V)
  ✓ モータ校正済みフラグ: True
  ✓ モータ校正状態: 校正済み

  [参考] 測定された相抵抗: 0.2605 Ω
  [参考] 測定された相インダクタンス: 0.000125 H

============================================================
【エンコーダパラメータ】
============================================================
  ✓ エンコーダCPR: 16384
  ✓ エンコーダ校正済みフラグ: True
  ✓ エンコーダ準備状態: 準備完了

============================================================
【コントローラパラメータ】
============================================================
  ✓ 速度制限: 30.0 turn/s (期待値: 30.0 turn/s, 誤差: 0.000000 turn/s)
  ✓ トルクモード速度リミット: True
  ✓ 位置ゲイン: 20.0 (期待値: 20.0, 誤差: 0.000000)
  ✓ 速度ゲイン: 0.1599999964237213 (期待値: 0.16, 誤差: 0.000000)
  ✓ 速度積分ゲイン: 0.3199999928474426 (期待値: 0.32, 誤差: 0.000000)

============================================================
【電源パラメータ】
============================================================
  ✓ 過電圧保護レベル: 48.0 V (期待値: 48.0 V, 誤差: 0.000000 V)
  ✓ 低電圧保護レベル: 12.0 V (期待値: 12.0 V, 誤差: 0.000000 V)
  [参考] 放電電流最大値(負): -10.0 A
  [参考] 放電電流最大値(正): 15.0 A
  [参考] 現在のバス電圧: 23.88 V

============================================================
【温度保護パラメータ】
============================================================
  <モータサーミスタ>
  ✓     有効化: True
  ✓     下限温度: 20.0 ℃
  ✓     上限温度: 100.0 ℃
    [参考] 現在温度: 36.6 ℃

  <FETサーミスタ>
  ✓     有効化: True
  ✓     下限温度: 20.0 ℃
  ✓     上限温度: 100.0 ℃
    [参考] 現在温度: 44.2 ℃

============================================================
【CANバスパラメータ】
============================================================
  ✓ ボーレート: 1000000 bps
  ✓ エンコーダカウント更新レート: 10 ms
  ✓ バスVI更新レート: 100 ms

============================================================
【エラー状態】
============================================================
  ✓ エラーなし
  [参考] 現在の状態: IDLE

============================================================
【確認結果サマリ】
============================================================
  合格: 27/27
  不合格: 0/27

  ✓ すべてのパラメータが期待値と一致しています！
b-sky-lab@Mac software % 
```

注意事項:
- スクリプトは `GIM6010Verifier.EXPECTED` に定義された期待値と比較します．必要に応じて値や許容誤差（TOLERANCE）を変更してください．
- 一部のチェックは警告（再起動後に反映されるキャリブレーション状態など）として扱われ，即時失敗としない場合があります．

---

## トラブルシューティング

- ODriveに接続できない:
	- ケーブル接続，電源，別のプロセスがシリアルを使用していないかを確認してください．

- キャリブレーションが失敗する／時間切れになる:
	- 出力軸がロックされていないか，機械的に過負荷がかかっていないか確認してください．
	- `CALIBRATION_CURRENT` や `resistance_calib_max_voltage` の値を見直してください．電源電圧の半分より少し低い程度が推奨されているようです．

- 設定保存後に再接続できない:
	- 保存による再起動で接続が切れるのは正常です．再接続を待つか手動でODriveの電源を再投入してください．

---

## 開発者向けメモ

- 主要な定数や期待値はそれぞれのファイル内のクラス定義にハードコードされています:
	- `GIM6010Setup`（`execute_setup_and_calibrate.py`）
	- `GIM6010Verifier.EXPECTED`（`verify_setup_and_calibrate.py`）
- 自動化する場合はプロンプト部分を引数化するか，ラッパーを作成して非対話モードで利用することを推奨します．

---

## 変更履歴 / 著者

- Author: Yutaro KIMURA
- ファイル作成日（参照ヘッダ）: 2025-10-02

---

もし，これに追加してほしい項目（例: 自動化ラッパー，追加の診断コマンド，具体的なCI設定例など）があれば教えてください．
